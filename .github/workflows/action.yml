
name: Test, Build and Release apk

on:
  push:
    branches:
      - master

jobs:
  process:
    name: all process
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装JDK
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: FlutterAction
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: 下载依赖
        run: flutter pub get


      - name: 打包安卓
        run: flutter build apk --release
        env:
          KEYSTORE_KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS }}
          KEYSTORE_KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD }}
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}

      - name: 获取版本号
        run: |
          echo "version=$(awk -F': ' '/version:/ {gsub("\\+", "-", $2); print $2}' pubspec.yaml)" >> "$GITHUB_ENV"

      - name: 打印版本号
        run: |
          echo "version: ${{ env.version }}"

      - name: Release apk
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ env.version }}"
          draft: false
          artifacts: "build/app/outputs/flutter-apk/*"
          allowUpdates: true
          generateReleaseNotes: true
          token: ${{ secrets.TOKEN }}